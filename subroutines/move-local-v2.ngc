o<move-local-v2> SUB

M70

; if we're in G21 convert X, Y and Z to inches, otherwise use what was passed in
; we need to do this because #5221-#5390 are in inches
#<_x0> = [ #[5221+20*[#5220-1]] + [ #<X> / 25.4 * #<_metric> ] + [ #<X> * #<_imperial> ] ]
#<_y0> = [ #[5222+20*[#5220-1]] + [ #<Y> / 25.4 * #<_metric> ] + [ #<Y> * #<_imperial> ] ]
#<_z0> = [ #[5223+20*[#5220-1]] + [ #<Z> / 25.4 * #<_metric> ] + [ #<Z> * #<_imperial> ] ]
#<_a0> = #[5224+20*[#5220-1]]
#<_b0> = #[5225+20*[#5220-1]]

G90 G20

#<_CA0> = [ COS[#<_a0>] ]
#<_SA0> = [ SIN[#<_a0>] ]
#<_CB0> = [ COS[#<_b0>] ]
#<_SB0> = [ SIN[#<_b0>] ]

#<_x1> = [ #<_x0>*#<_CB0> + #<_z0>*#<_SB0> ]
#<_y1> = [ #<_x0>*#<_SB0>*#<_SA0>+#<_y0>*#<_CA0> - #<_z0>*#<_CB0>*#<_SA0> ]
#<_z1> = [ -#<_x0>*#<_SB0>*#<_CA0>+#<_y0>*#<_SA0> + #<_z0>*#<_CB0>*#<_CA0> ]
#<_a1> = [ #5423+#<_a0>-#5214 ]
#<_b1> = [ #5424+#<_b0>-#5215 ]

#<_CA1> = [ COS[#<_a1>] ]
#<_SA1> = [ SIN[#<_a1>] ]
#<_CB1> = [ COS[#<_b1>] ]
#<_SB1> = [ SIN[#<_b1>] ]

#<_newX> = [ [ [ #<_x1>*#<_CB1> + #<_z1>*#<_SB1> ] - #[5221+20*[#5220-1]] ]  * #<I> + [ #<_x> * [ 1 - #<I> ] ] ]
#<_newY> = [ [ [ #<_x1>*#<_SB1>*#<_SA1>+#<_y1>*#<_CA1> - #<_z1>*#<_CB1>*#<_SA1> ] - #[5222+20*[#5220-1]] ] * #<J> + [ #<_y> * [ 1 - #<J> ] ] ]
#<_newZ> = [ [ [ -#<_x1>*#<_SB1>*#<_CA1>+#<_y1>*#<_SA1> + #<_z1>*#<_CB1>*#<_CA1> ] - #[5223+20*[#5220-1]] ] * #<K> + [ #<_z> * [ 1 - #<K> ] ] ]

o100 if [ EXISTS [ #<F> ] ]
  G#<P> X#<_newX> Y#<_newY> Z#<_newZ> F#<F>
o100 else
  G#<P> X#<_newX> Y#<_newY> Z#<_newZ>
o100 endif

M72
O<move-local-v2> ENDSUB
M2
