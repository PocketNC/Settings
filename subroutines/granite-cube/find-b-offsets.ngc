; An approximate tool length must be known at this point
; and must be active with G43 (see find-nominal-probe-length-offset).
; B should be mostly zeroed already

o<find-b-offsets> sub

o100 if [ #<_tool_offset> NE 1 ]
  (abort,You must have a tool length offset in place)
o100 endif


o<push_feature_set> call
M70

o400 if [ABS[ #[5201 + [ 20 * #5220 ]]] GT .00001 ]
  (abort,Active X work offset must be 0.)
o400 endif

o500 if [ABS[ #[5202 + [ 20 * #5220 ]]] GT .00001 ]
  (abort,Active Y work offset must be 0.)
o500 endif

o600 if [ABS[ #[5203 + [ 20 * #5220 ]]] GT .00001 ]
  (abort,Active Z work offset must be 0.)
o600 endif

o700 if [ABS[ #[5205 + [ 20 * #5220 ]]] GT .00001 ]
  (abort,Active B work offset must be 0.)
o700 endif

o800 if [ABS[ #[5206 + [ 20 * #5220 ]]] GT .00001 ]
  (abort,Active C work offset must be 0.)
o800 endif

G20 
G90 G94 G40 G17 G91.1
M429

G53 G0 Z0

;F#<_ini[TOOL_PROBE]FEED_TRAVEL>
;G90 G1 Y1.75 X1.75
;G90 G1 Z1.3291
;o<add-points-probe-line> call [-1] [0] [0] [0] [0] [-1] [2] [3.5] [0.51] [#<_ini[TOOL_PROBE]FEED_TRAVEL> ] [#<_ini[TOOL_PROBE]FEED_FAST> ] [#<_ini[TOOL_PROBE]FEED_BACK> ] [ #<_ini[TOOL_PROBE]FEED_SLOW> ] [1]
;G91 G0 B[ -#<_penta_line_angle_about_y> ]
;o<clear_points> call

F#<_ini[TOOL_PROBE]FEED_TRAVEL>
G90 G1 Y1.75 X2.25
G90 G1 Z1.9351

G90 G1 X1.75

o<probe-on> call
o<add-points-probe-line> call [-1] [0] [0] [0] [0] [-1] [30] [3.5] [0.15] [#<_ini[TOOL_PROBE]FEED_TRAVEL> ] [#<_ini[TOOL_PROBE]FEED_FAST> ] [#<_ini[TOOL_PROBE]FEED_BACK> ] [ #<_ini[TOOL_PROBE]FEED_SLOW> ] [1]
o<probe-off> call

;py,append_feature_map("b-offsets")

G53 G0 Z0

;G91 G0 B[ -#<_penta_line_angle_about_y> ]

#<bOffset> = [ #5424 - #<_penta_line_angle_about_y> ]

;debug,B Offset #<bOffset>

(logappend,b-offsets.txt)
(log,#<bOffset>)
(logclose)

M72
o<pop_feature_set> call

o<find-b-offsets> endsub
M2
