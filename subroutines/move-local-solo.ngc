o<move-local-solo> SUB

M70

; if we're in G21 convert X, Y and Z to inches, otherwise use what was passed in
; we need to do this because #5221-#5390 are in inches
#<_x0> = [ #[5221+20*[#5220-1]] + [ #<X> / 25.4 * #<_metric> ] + [ #<X> * #<_imperial> ] ]
#<_y0> = [ #[5222+20*[#5220-1]] + [ #<Y> / 25.4 * #<_metric> ] + [ #<Y> * #<_imperial> ] ]
#<_z0> = [ #[5223+20*[#5220-1]] + [ #<Z> / 25.4 * #<_metric> ] + [ #<Z> * #<_imperial> ] ]
#<_b0> = #[5225+20*[#5220-1]]
#<_c0> = #[5226+20*[#5220-1]]

; switch to absolute mode and inches mode
G90 G20

#<_CB0> = [ COS[#<_b0>] ]
#<_SB0> = [ SIN[#<_b0>] ]
#<_CC0> = [ COS[#<_c0>] ]
#<_SC0> = [ SIN[#<_c0>] ]

#<_x1> = [ #<_x0>*#<_CB0>*#<_CC0> - #<_y0>*#<_SC0>*#<_CB0> + #<_z0>*#<_SB0> ]
#<_y1> = [ #<_x0>*#<_SC0>+#<_y0>*#<_CC0> ]
#<_z1> = [ -#<_x0>*#<_CC0>*#<_SB0>+#<_y0>*#<_SC0>*#<_SB0> + #<_z0>*#<_CB0> ]
#<_b1> = [ #5424+#<_b0>-#5215 ]
#<_c1> = [ #5425+#<_c0>-#5216 ]

#<_CB1> = [ COS[#<_b1>] ]
#<_SB1> = [ SIN[#<_b1>] ]
#<_CC1> = [ COS[#<_c1>] ]
#<_SC1> = [ SIN[#<_c1>] ]

#<_newX> = [ [ [ #<_x1>*#<_CB1>*#<_CC1> - #<_y1>*#<_SC1>*#<_CB1> + #<_z1>*#<_SB1> ] - #[5221+20*[#5220-1]] ] * #<I> + [ #<_x> * [ 1 - #<I> ] ] ]
#<_newY> = [ [ [ #<_x1>*#<_SC1>+#<_y1>*#<_CC1> ] - #[5222+20*[#5220-1]]] * #<J> + [ #<_y> * [ 1 - #<J> ] ] ]
#<_newZ> = [ [ [ -#<_x1>*#<_CC1>*#<_SB1>+#<_y1>*#<_SC1>*#<_SB1> + #<_z1>*#<_CB1> ] - #[5223+20*[#5220-1]]] * #<K> + [ #<_z> *[ 1 - #<K> ] ] ]

G#<P> X#<_newX> Y#<_newY> Z#<_newZ>

M72
O<move-local-solo> ENDSUB
