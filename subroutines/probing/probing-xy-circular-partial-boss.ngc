o<probing-xy-circular-partial-boss> sub
  #<angle1> = #1
  #<angle2> = #2
  #<angle3> = #3
  #<diameter> = #4
  #<z> = #5
  #<overTravel> = #6
  #<clearance> = #7
  #<tolerancePositionCheck> = #8
  #<tolerancePosition> = #9
  #<toleranceSizeCheck> = #10
  #<toleranceSize> = #11
  #<updateWCS> = #12
  #<wcs> = #13
  #<printResults> = #14
  #<feed> = #15

  o<push_feature_set> call

  #<probeDiameter> = [ #<_ini[TOOL_PROBE]DIAMETER> * [ #<_metric> * 25.4 + #<_imperial> ] ]
  #<fastFeed> =  [ #<_ini[TOOL_PROBE]FEED_FAST> * [ #<_metric> * 25.4 + #<_imperial> ]] 
  #<backFeed> = [ #<_ini[TOOL_PROBE]FEED_BACK> * [ #<_metric> * 25.4 + #<_imperial> ]] 
  #<slowFeed> = [ #<_ini[TOOL_PROBE]FEED_SLOW> * [ #<_metric> * 25.4 + #<_imperial> ]]

  #<startX> = #5420
  #<startY> = #5421
  #<startZ> = #5422

  #<dZ> = [ #<z> - #<startZ> ]

  #<dX1> = [ [ #<diameter>*.5 + #<clearance> ] * COS[ #<angle1> ] ]
  #<dY1> = [ [ #<diameter>*.5 + #<clearance> ] * SIN[ #<angle1> ] ]

  #<dX2> = [ [ #<diameter>*.5 + #<clearance> ] * COS[ #<angle2> ] ]
  #<dY2> = [ [ #<diameter>*.5 + #<clearance> ] * SIN[ #<angle2> ] ]

  #<dX3> = [ [ #<diameter>*.5 + #<clearance> ] * COS[ #<angle3> ] ]
  #<dY3> = [ [ #<diameter>*.5 + #<clearance> ] * SIN[ #<angle3> ] ]

  #<pdX1> = [ [ -#<clearance> - #<overTravel> ] * COS[ #<angle1> ] ]
  #<pdY1> = [ [ -#<clearance> - #<overTravel> ] * SIN[ #<angle1> ] ]

  #<pdX2> = [ [ -#<clearance> - #<overTravel> ] * COS[ #<angle2> ] ]
  #<pdY2> = [ [ -#<clearance> - #<overTravel> ] * SIN[ #<angle2> ] ]

  #<pdX3> = [ [ -#<clearance> - #<overTravel> ] * COS[ #<angle3> ] ]
  #<pdY3> = [ [ -#<clearance> - #<overTravel> ] * SIN[ #<angle3> ] ]

  o<protected-move-relative> call [ #<dX1> ] [ #<dY1> ] [ 0 ] [ #<feed> ]
  o<protected-move-relative> call [ 0 ] [ 0 ] [ #<dZ> ] [ #<feed> ]

  o<add-point-probe-relative> call [ #<pdX1> ] [ #<pdY1> ] [ 0 ] [ #<fastFeed> ] [ #<backFeed> ] [ #<slowFeed> ]

  o<protected-move-relative> call [ 0 ] [ 0 ] [ -#<dZ> ] [ #<feed> ]
  o<protected-move-relative> call [ -#<dX1> ] [ -#<dY1> ] [ 0 ] [ #<feed> ]

  o<protected-move-relative> call [ #<dX2> ] [ #<dY2> ] [ 0 ] [ #<feed> ]
  o<protected-move-relative> call [ 0 ] [ 0 ] [ #<dZ> ] [ #<feed> ]

  o<add-point-probe-relative> call [ #<pdX2> ] [ #<pdY2> ] [ 0 ] [ #<fastFeed> ] [ #<backFeed> ] [ #<slowFeed> ]

  o<protected-move-relative> call [ 0 ] [ 0 ] [ -#<dZ> ] [ #<feed> ]
  o<protected-move-relative> call [ -#<dX2> ] [ -#<dY2> ] [ 0 ] [ #<feed> ]

  o<protected-move-relative> call [ #<dX3> ] [ #<dY3> ] [ 0 ] [ #<feed> ]
  o<protected-move-relative> call [ 0 ] [ 0 ] [ #<dZ> ] [ #<feed> ]

  o<add-point-probe-relative> call [ #<pdX3> ] [ #<pdY3> ] [ 0 ] [ #<fastFeed> ] [ #<backFeed> ] [ #<slowFeed> ]

  o<protected-move-relative> call [ 0 ] [ 0 ] [ -#<dZ> ] [ #<feed> ]
  o<protected-move-relative> call [ -#<dX3> ] [ -#<dY3> ] [ 0 ] [ #<feed> ]

  #<size> = [ #<_penta_circle_diameter> - #<probeDiameter> ]

  #<centerX> = [ #<_penta_circle_center_x> ]
  #<centerY> = [ #<_penta_circle_center_y> ]
  #<centerZ> = [ #<_penta_circle_center_z> ]

  #<cx> = [ #<centerX> - #<startX> ]
  #<cy> = [ #<centerY> - #<startY> ]

  #<sizeDeviation> = [ #<size> - #<diameter> ]
  #<positionDeviation> = [ SQRT[ #<cx>*#<cx> + #<cy>*#<cy> ] ]

  o300 if [ #<printResults> EQ 1 ]
    ;debug,Probed XY circular partial boss center = (#<centerX>,#<centerY>), Diameter = #<size>
  o300 endif

  o600 if [ #<tolerancePositionCheck> EQ 1 ]
    o200 if [ ABS [ #<positionDeviation> ]  GT #<tolerancePosition> ]
       M66  E0 L0
      #<absDev> = [ ABS[ #<positionDeviation> ] ]
      ;abort,Probing XY circular partial boss failed positional tolerance check. Probed (#<centerX>,#<centerY>), expected (#<startX>,#<startY>). #<absDev> > #<tolerancePosition>
    o200 endif
  o600 endif

  o700 if [ #<toleranceSizeCheck> EQ 1 ]
    o800 if [ ABS [ #<sizeDeviation> ]  GT #<toleranceSize> ]
       M66  E0 L0
      #<absDev> = [ ABS[ #<sizeDeviation> ] ]
      (abort,Probing XY circular partial boss failed size tolerance check. Probed #<size>, expected #<diameter>. #<absDev> > #<toleranceSize>)
    o800 endif
  o700 endif

  o400 if [ [ #<updateWCS> EQ 1 ] AND [ #<wcs> GE 1 ] AND [ #<wcs> LE 9 ]]
    ; The numbered parameters for the current wcs offsets are always in inches, so convert to active units.
    #<currentWCS_X> = [ #[5221+20*[#5220-1]] * [ #<_metric> * 25.4 + #<_imperial> ] ]
    #<currentWCS_Y> = [ #[5222+20*[#5220-1]] * [ #<_metric> * 25.4 + #<_imperial> ] ]

    ; Then add the probed position
    #<newWCS_X> = [ #<currentWCS_X> + #<centerX> ]
    #<newWCS_Y> = [ #<currentWCS_Y> + #<centerY> ]

    ; And store it in the appropriate WCS
    G10 L2 P#<wcs> X#<newWCS_X> Y#<newWCS_Y>
  o400 endif

  o<pop_feature_set> call

o<probing-xy-circular-partial-boss> endsub
M2
