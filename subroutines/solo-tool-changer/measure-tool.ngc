o<measure-tool> sub
; Note that this routine intentionally uses relative moves and G53
; moves to avoid issues with G5x offsets shifting our commands around.

; Ensure the probe is off when tool setting
M66 P#<_ini[PENTA]PROBE_ON_DIGITAL_IN> L0
o100 if [ ABS[ 1 - #5399 ] LT .000001 ]
  o<probe-off> call
o100 endif

#<feedTravel> = #<_ini[TOOL_PROBE]FEED_TRAVEL>
#<feedFast> = #<_ini[TOOL_PROBE]FEED_FAST>
#<feedBack> = #<_ini[TOOL_PROBE]FEED_BACK>
#<feedSlow> = #<_ini[TOOL_PROBE]FEED_SLOW>

M70

G30.1

G20
G90 G94 G40 G17 G91.1
G49
G61.1
M429

G53 G0 Z0
G53 G0 B-90

G53 G1 F#<feedTravel> X#<_ini[TOOL_SETTER]X> Y#<_ini[TOOL_SETTER]Y>

G54 G91
G38.2 F20 Z[ #<_ini[TOOL_SETTER]Z> ]

#<fastTrippedZ> = [ #5063 + #5223 ]

; Back off the tool setter
G38.4 F#<feedBack> Z[ ABS[#<fastTrippedZ>] ]

; Go a little further
G91 G1 F#<feedBack> Z0.001

; Touch the tool setter at a slower speed to get
; a more precise measurement
G38.2 F#<feedSlow> Z[ -ABS[#<fastTrippedZ>]-.001 ]
#<slowTrippedZ> = [ #5063 + #5223 ]

#<toolLengthOffset> = [ #<slowTrippedZ> - #<_ini[TOOL_SETTER]TRIGGER_Z> ]

G90

G10 L1 P#5400 Z#<toolLengthOffset>

G53 G0 Z0
G53 G0 B0

M72

o<measure-tool> endsub
M2
